<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simula√ß√£o de Envio Smart Conecta</title>
<style>
  :root{
    --brand:#16a34a; --brand-2:#0f7a36; --brand-3:#1ed760;
    --bg:#0a0f0c; --panel:#101a13; --ink:#e9f7ec; --muted:#9ad1ac; --line:#1a2a1f;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#0b1711 55%,#0a1410);color:var(--ink)}
  a{color:var(--brand-3);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1200px;margin:auto;padding:28px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:18px;box-shadow:0 14px 50px rgba(0,0,0,.35)}
  .head{padding:20px 22px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .head h1{margin:0;font-size:20px}
  .head .right{display:flex;gap:12px;align-items:center}
  .pill{padding:5px 12px;border-radius:999px;background:#0c1a13;color:var(--muted);font-size:12px;border:1px solid var(--line)}
  .body{padding:22px}
  .section{margin-top:28px;padding:18px 18px 6px;border:1px dashed var(--line);border-radius:14px;background:#0d1812}
  .section + .section{margin-top:26px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0}
  .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#102217;border:1px solid var(--line);color:var(--ink)}
  .btn.red{background:#b63a3a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  input,select{background:#0c1912;border:1px solid var(--line);color:var(--ink);padding:10px;border-radius:10px;outline:none}
  input:focus,select:focus{border-color:var(--brand)}
  /* Abas */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .tab{background:#0f2118;border:1px solid var(--line);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#0a120d}
  /* Tabela */
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:12px;border-top:1px solid var(--line);text-align:left;font-size:14px}
  .table th{color:#c9f2d6;font-weight:700}
  .right{text-align:right}
  .qty{width:76px;text-align:center}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
  .col-2{grid-column:span 2}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}
  .totbox{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .tot{background:#0c1912;border:1px solid var(--line);border-radius:12px;padding:14px}
  .tot b{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .tot span{font-size:18px}
  /* Simula√ß√µes */
  .simlist{margin-top:12px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0d1812}
  .simlist table{width:100%;border-collapse:collapse}
  .simlist th,.simlist td{padding:12px;border-top:1px solid var(--line);text-align:left;font-size:14px}
  .simlist th{color:#c9f2d6}
  .sim-detail{background:#0c1912}
  .sim-detail pre{white-space:pre-wrap;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#cfe9d7}
  /* Modal */
  dialog{border:none;border-radius:16px;background:#0d1812;color:#e8f6ec;padding:16px;max-width:650px;width:92%}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .modal-body{display:grid;gap:10px}
  .hint{font-size:12px;color:var(--muted)}
  /* Fotos (Perif√©ricos) */
  .foto-section{border-top:1px solid var(--line);padding-top:10px;margin-top:4px}
  .thumbs{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .thumb{position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#0c1912}
  .thumb img{display:block;width:100%;height:74px;object-fit:cover}
  .thumb button{position:absolute;top:4px;right:4px;border:none;border-radius:8px;padding:4px 6px;background:#b63a3a;color:#fff;cursor:pointer}
  /* Aviso de caixa */
  .warn{margin-top:12px;padding:10px;border:1px solid #6b1f1f;background:#170f10;border-radius:10px}
  .warn b{color:#ffd1d1}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <h1>Simula√ß√£o de Envio Smart Conecta</h1>
      <div class="right">
        <a href="https://www.smartconecta.com.br/" target="_blank" rel="noopener">smartconecta.com.br</a>
        <span class="pill">Salvo no navegador</span>
      </div>
    </div>

    <div class="body">
      <!-- Categorias -->
      <div class="section">
        <div class="tabs" id="catTabs">
          <button class="tab active" data-cat="geral">[geral]</button>
          <button class="tab" data-cat="note">[note]</button>
          <button class="tab" data-cat="impressora">[impressora]</button>
          <button class="tab" data-cat="monitor">[monitor]</button>
          <button class="tab" data-cat="perifericos">[perifericos]</button>
          <button class="tab" data-cat="caixa">[caixa]</button>
        </div>

        <div class="toolbar">
          <button class="btn" id="btnAdd">Adicionar item</button>
          <button class="btn red" id="btnClear" title="Apagar todos os itens">Limpar itens</button>
          <input class="search" id="txtSearch" placeholder="Buscar por nome (ex.: hp 840 g8, brother 2540, caixa 30x30x30)">
          <span class="muted" id="countInfo"></span>
        </div>

        <!-- Tabela -->
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th><input type="checkbox" id="chkAll" title="Selecionar p√°gina"></th>
              <th>Item</th>
              <th class="right">Peso (kg)</th>
              <th class="right">Altura (cm)</th>
              <th class="right">Largura (cm)</th>
              <th class="right">Comprimento (cm)</th>
              <th class="right">Qtd</th>
              <th class="right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <!-- Pagina√ß√£o -->
        <div class="toolbar" style="justify-content:flex-end;margin-top:10px">
          <button class="btn ghost" id="btnPrev" title="P√°gina anterior">&lt;</button>
          <span class="muted" id="pageInfo">P√°gina 1/1</span>
          <button class="btn ghost" id="btnNext" title="Pr√≥xima p√°gina">&gt;</button>
        </div>
      </div>

      <!-- Controles de estimativa -->
      <div class="section">
        <div class="grid">
          <div class="col-3">
            <label class="muted">Modo de empacotamento</label>
            <select id="packMode" title="Como estimar a caixa combinada">
              <option value="stack" selected>Empilhar (altura soma)</option>
              <option value="auto">Auto (camadas)</option>
              <option value="side">Lado a lado (comprimento soma)</option>
            </select>
          </div>
          <div class="col-3">
            <label class="muted">Folga interna (cm)</label>
            <input type="number" id="margin" step="1" min="0" value="3" title="Folga adicionada a cada dimens√£o (estimativa)">
          </div>
          <div class="col-6" style="display:flex;gap:10px;align-items:center">
            <button class="btn" id="btnCopy">Copiar resumo</button>
            <span class="hint">Selecione itens, ajuste as quantidades e salve como cota√ß√£o.</span>
          </div>
        </div>
      </div>

      <!-- Resumo -->
      <div class="section">
        <div class="totbox">
          <div class="tot"><b>Itens selecionados (equip.)</b><span id="resCount">0 un.</span></div>
          <div class="tot"><b>Peso total real (equip.)</b><span id="resPeso">0,00 kg</span></div>
          <div class="tot"><b>Peso cubado</b><span id="resCubado">0,00 kg</span></div>
        </div>
        <div class="totbox" style="margin-top:12px">
          <div class="tot"><b>Altura estimada/caixa</b><span id="resAlt">‚Äì</span></div>
          <div class="tot"><b>Largura estimada/caixa</b><span id="resLarg">‚Äì</span></div>
          <div class="tot"><b>Comprimento estimado/caixa</b><span id="resComp">‚Äì</span></div>
        </div>
        <div id="boxWarn" class="warn" style="display:none"></div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn" id="btnSaveSim">Salvar cota√ß√£o</button>
          <button class="btn ghost" id="btnClearSim" title="Limpar sele√ß√£o e resumo">Limpar simula√ß√£o</button>
          <span class="hint">Armazena at√© <b>10</b> simula√ß√µes (as mais recentes).</span>
        </div>
      </div>

      <!-- Simula√ß√µes salvas -->
      <div class="section">
        <div class="simlist">
          <table>
            <thead>
              <tr>
                <th>Nome</th><th>Itens</th><th>Peso</th><th>Caixa (A√óL√óC)</th><th>Data</th><th class="right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbodyMain"></tbody>
          </table>
        </div>
      </div>

    </div>
    <div class="footer" style="padding:14px 22px">Baseado em dimens√µes/peso cadastrados. Ajuste conforme o seu mix real.</div>
  </div>
</div>

<!-- Modal add/edit -->
<dialog id="dlg">
  <div class="modal-head">
    <h3 id="dlgTitle">Novo item</h3>
    <button class="btn ghost" id="dlgClose">Fechar</button>
  </div>
  <div class="modal-body">
    <div class="grid">
      <div class="col-6"><input id="fNome" placeholder="Nome do item (ex.: Brother DCP-L2540DW)"></div>
      <div class="col-3"><input id="fPeso" type="number" step="0.01" min="0" placeholder="Peso (kg)"></div>
    </div>
    <div class="grid">
      <div class="col-2"><input id="fAlt" type="number" step="0.1" min="0" placeholder="Altura (cm)"></div>
      <div class="col-2"><input id="fLarg" type="number" step="0.1" min="0" placeholder="Largura (cm)"></div>
      <div class="col-2"><input id="fComp"  type="number" step="0.1" min="0" placeholder="Comprimento (cm)"></div>
      <div class="col-6"><span class="hint">O item ser√° salvo na sess√£o atual <b id="dlgSessaoAtual">[geral]</b>.</span></div>
    </div>

    <!-- Se√ß√£o de fotos (apenas para perif√©ricos) -->
    <div id="fotoSection" class="foto-section" style="display:none">
      <b style="display:block;margin-bottom:6px">Fotos (apenas para [perifericos])</b>
      <input id="fFotos" type="file" accept="image/*" multiple>
      <span class="hint">As imagens s√£o reduzidas para economizar espa√ßo (salvas no navegador).</span>
      <div class="thumbs" id="fotoGrid" style="margin-top:8px"></div>
    </div>

    <div class="grid" style="margin-top:4px">
      <div class="col-6" style="display:flex;gap:10px;align-items:center">
        <button class="btn" id="dlgSave">Salvar</button>
        <button class="btn red" id="dlgDelete" style="display:none">Excluir</button>
        <span class="hint" id="dlgHint"></span>
      </div>
    </div>
  </div>
</dialog>

<!-- Modal nome da simula√ß√£o -->
<dialog id="dlgSim">
  <div class="modal-head">
    <h3>Salvar cota√ß√£o</h3>
    <button class="btn ghost" id="dlgSimClose">Fechar</button>
  </div>
  <div class="modal-body">
    <input id="simName" placeholder="Nome da simula√ß√£o (ex.: 2 impressoras + 1 monitor)">
    <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
      <button class="btn" id="dlgSimSave">Salvar</button>
      <span class="hint">Mant√©m no m√°ximo <b>10</b> cota√ß√µes.</span>
    </div>
  </div>
</dialog>

<script>
/* ===== Util ===== */
const $=s=>document.querySelector(s), $all=s=>Array.from(document.querySelectorAll(s));
const fmtKG=n=>(Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})+' kg';
const fmtDate=iso=>new Date(iso).toLocaleString('pt-BR');
const clampQty=v=>Math.max(1,Math.floor(Number(v)||1)); // quantidade
const clampNonNeg=v=>Math.max(0,Number(v)||0); // peso e dimens√µes
const LS_KEY_ITEMS='ri_items_v7';
const LS_KEY_S1='ri_sims_main_v5';
const LIMITE_PESO_CORREIOS = 30; // limite por volume dos Correios (kg)
function uid(){return Math.random().toString(36).slice(2,9)}

/* ===== Estado ===== */
let items=loadItems();
let simsMain=loadSims(LS_KEY_S1);
let editingId=null;

let currentCat='geral';
let currentPage=1;
const perPage=10;
let selectedIds=new Set();
let qtyMap=new Map(); // {id -> qtd}

let dlgFotosTemp=[]; // buffer de fotos do modal

renderTable(); renderSims(); updateCountInfo();

/* ===== Seeds ===== */
function seedItems(){
  return [
    {id:uid(),cat:'impressora',nome:'Brother DCP-L2540DW',peso:11.1,alt:35.6,larg:42.8,comp:42.9},
    {id:uid(),cat:'impressora',nome:'Brother DCP-L5652DN',peso:17.1,alt:60.0,larg:60.0,comp:52.5},
    {id:uid(),cat:'impressora',nome:'Brother MFC-L8900CDW',peso:28.6,alt:54.9,larg:52.6,comp:49.5},
    {id:uid(),cat:'impressora',nome:'Epson L14150',peso:9.7,alt:25.9,larg:50.6,comp:36.5},
    {id:uid(),cat:'monitor',nome:'Monitor Diversos (com base)',peso:2.88,alt:30.12,larg:50.33,comp:2.0},
    {id:uid(),cat:'note',nome:'Notebook 15',peso:1.90,alt:3.0,larg:36.0,comp:25.0},
    {id:uid(),cat:'note',nome:'Notebook 14',peso:1.90,alt:3.0,larg:34.0,comp:23.0},
    {id:uid(),cat:'geral',nome:'All in One Positivo U1500',peso:4.14,alt:34.2,larg:45.5,comp:3.9},
    {id:uid(),cat:'perifericos',nome:'Modem',peso:0.99,alt:15.0,larg:15.0,comp:3.00},
    {id:uid(),cat:'perifericos',nome:'Mouse',peso:0.85,alt:4.0,larg:6.0,comp:12.0},
    {id:uid(),cat:'perifericos',nome:'Toner 5652',peso:1.00,alt:7.0,larg:28.0,comp:16.0},
    {id:uid(),cat:'perifericos',nome:'Toner 2540',peso:1.00,alt:4.0,larg:28.0,comp:12.0},
    {id:uid(),cat:'perifericos',nome:'Fonte',peso:0.99,alt:3.0,larg:11.0,comp:5.0},
    {id:uid(),cat:'perifericos',nome:'Transformador',peso:4.00,alt:13.00,larg:14.0,comp:10.0},    
    // Caixa (exemplo do pedido)
    {id:uid(),cat:'caixa',nome:'Caixa Brother 2540',peso:0,alt:42,larg:55,comp:51},
    {id:uid(),cat:'caixa',nome:'Caixa Brother 5652',peso:0,alt:60,larg:60,comp:60},
    {id:uid(),cat:'caixa',nome:'Caixa Notebook',peso:0,alt:7,larg:45,comp:35},
    {id:uid(),cat:'caixa',nome:'Caixa Padr√£o',peso:0,alt:30,larg:30,comp:30}
  ];
}

/* ===== Storage ===== */
function loadItems(){
  const keysTry=['ri_items_v7','ri_items_v6'];
  for(const k of keysTry){
    const raw=localStorage.getItem(k);
    if(raw){ try{
      let arr=JSON.parse(raw);
      // garantia de campos
      arr=arr.map(it=>({fotos:[],...it}));
      // migra√ß√£o: mover para nova key
      if(k!=='ri_items_v7') localStorage.setItem('ri_items_v7',JSON.stringify(arr));
      return arr;
    }catch(e){} }
  }
  return seedItems();
}
function saveItems(){ localStorage.setItem(LS_KEY_ITEMS,JSON.stringify(items)); }
function loadSims(key){ const raw=localStorage.getItem(key); if(raw){try{return JSON.parse(raw);}catch(e){}} return []; }
function saveSims(){ localStorage.setItem(LS_KEY_S1,JSON.stringify(simsMain)); }

/* ===== Filtro + Pagina√ß√£o ===== */
function getFiltered(){
  const q=($('#txtSearch').value||'').trim().toLowerCase();
  if(currentCat==='geral') return items.filter(it=>it.nome.toLowerCase().includes(q));
  return items.filter(it=>it.cat===currentCat && it.nome.toLowerCase().includes(q));
}
function getPaged(list){
  const total=list.length;
  const pages=Math.max(1,Math.ceil(total/perPage));
  if(currentPage>pages) currentPage=pages;
  const start=(currentPage-1)*perPage;
  return {page:list.slice(start,start+perPage), total, pages};
}
function updatePager(total,pages){
  $('#pageInfo').textContent=`P√°gina ${currentPage}/${pages}`;
  $('#btnPrev').disabled=currentPage<=1;
  $('#btnNext').disabled=currentPage>=pages;
  $('#chkAll').checked=false;
}
function updateCountInfo(){
  const totalSegment=(currentCat==='geral'? items.length : items.filter(it=>it.cat===currentCat).length);
  $('#countInfo').textContent=`Sess√£o: ${currentCat} ‚Ä¢ ${totalSegment} itens`;
}

/* ===== Tabela ===== */
function renderTable(){
  const tbody=$('#tbody'); tbody.innerHTML='';
  const filtered=getFiltered();
  const {page,total,pages}=getPaged(filtered);
  page.forEach(it=>{
    const tr=document.createElement('tr');
    const checked=selectedIds.has(it.id);
    const qval = qtyMap.get(it.id) || 1;
    const fotoCount = (it.fotos && it.fotos.length) ? it.fotos.length : 0;
    tr.innerHTML=`
      <td><input type="checkbox" class="rowchk" data-id="${it.id}" ${checked?'checked':''}></td>
      <td>${it.nome}${it.cat==='perifericos' && fotoCount? ` <span class="muted">[üì∑ ${fotoCount}]</span>`:''}</td>
      <td class="right">${(it.peso||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td class="right">${it.alt||0}</td>
      <td class="right">${it.larg||0}</td>
      <td class="right">${it.comp||0}</td>
      <td class="right"><input type="number" min="1" step="1" class="qty" data-id="${it.id}" value="${qval}" ${checked?'':'disabled'} title="Quantidade"></td>
      <td class="right">
        <button class="btn ghost btnEdit" data-id="${it.id}">Editar</button>
        ${it.cat==='perifericos' ? `<button class="btn ghost btnPhotos" data-id="${it.id}">Fotos (${fotoCount})</button>`:''}
      </td>
    `;
    tbody.appendChild(tr);
  });
  $all('.btnEdit').forEach(b=>b.addEventListener('click',()=>openEdit(b.dataset.id)));
  $all('.btnPhotos').forEach(b=>b.addEventListener('click',()=>openEdit(b.dataset.id,true)));
  $all('.rowchk').forEach(chk=>{
    chk.addEventListener('change',e=>{
      const id=e.target.dataset.id;
      const qtyInput = document.querySelector(`.qty[data-id="${id}"]`);
      if(e.target.checked){
        selectedIds.add(id);
        if(!qtyMap.has(id)) qtyMap.set(id, 1);
        qtyInput.disabled=false;
      }else{
        selectedIds.delete(id);
        qtyInput.disabled=true;
      }
      updateSummary();
    });
  });
  $all('.qty').forEach(inp=>{
    inp.addEventListener('input',e=>{
      const id=e.target.dataset.id;
      const val=clampQty(e.target.value);
      e.target.value=val;
      qtyMap.set(id,val);
      if(selectedIds.has(id)) updateSummary();
    });
  });
  updatePager(total,pages);
  updateSummary();
}

/* ===== Modal Add/Edit ===== */
function setFotoSectionVisible(v){ $('#fotoSection').style.display = v ? '' : 'none'; }
function renderFotoGrid(){
  const grid=$('#fotoGrid'); grid.innerHTML='';
  dlgFotosTemp.forEach((src,idx)=>{
    const d=document.createElement('div');
    d.className='thumb';
    d.innerHTML=`<img src="${src}"/><button title="Remover" data-idx="${idx}">√ó</button>`;
    grid.appendChild(d);
  });
  grid.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const i=Number(btn.dataset.idx);
      dlgFotosTemp.splice(i,1);
      renderFotoGrid();
    });
  });
}
async function resizeImage(file, maxDim=1280, quality=0.8){
  const img=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  const el=new Image();
  el.src=img;
  await new Promise(r=>{ el.onload=r; el.onerror=r; });
  const {width:W,height:H}=el;
  let w=W,h=H;
  if (W>H && W>maxDim){ w=maxDim; h=Math.round(H*(maxDim/W)); }
  else if (H>=W && H>maxDim){ h=maxDim; w=Math.round(W*(maxDim/H)); }
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(el,0,0,w,h);
  return canvas.toDataURL('image/jpeg', quality);
}

function openNew(){
  editingId=null;
  $('#dlgTitle').textContent='Novo item';
  $('#fNome').value=''; $('#fPeso').value='';
  $('#fAlt').value=''; $('#fLarg').value=''; $('#fComp').value='';
  $('#dlgDelete').style.display='none'; $('#dlgHint').textContent='';
  $('#dlgSessaoAtual').textContent=`[${currentCat}]`;
  dlgFotosTemp=[];
  setFotoSectionVisible(currentCat==='perifericos');
  renderFotoGrid();
  $('#dlg').showModal();
}
function openEdit(id, gotoFotos=false){
  const it=items.find(x=>x.id===id); if(!it) return;
  editingId=id;
  $('#dlgTitle').textContent='Editar item';
  $('#fNome').value=it.nome; $('#fPeso').value=it.peso;
  $('#fAlt').value=it.alt; $('#fLarg').value=it.larg; $('#fComp').value=it.comp;
  $('#dlgDelete').style.display='inline-block';
  $('#dlgHint').textContent=`ID: ${id} ‚Ä¢ sess√£o: [${it.cat}]`;
  $('#dlgSessaoAtual').textContent=`[${it.cat}]`;
  dlgFotosTemp=Array.isArray(it.fotos)? [...it.fotos]:[];
  setFotoSectionVisible(it.cat==='perifericos');
  renderFotoGrid();
  $('#dlg').showModal();
  if(gotoFotos && it.cat==='perifericos'){
    setTimeout(()=>$('#fotoSection').scrollIntoView({behavior:'smooth'}),50);
  }
}
function saveFromModal(){
  const nome=($('#fNome').value||'').trim();
  const peso=clampNonNeg($('#fPeso').value);
  const alt=clampNonNeg($('#fAlt').value);
  const larg=clampNonNeg($('#fLarg').value);
  const comp=clampNonNeg($('#fComp').value);
  if(!nome){alert('Informe um nome.');return}
  if(editingId){
    const i=items.findIndex(x=>x.id===editingId);
    if(i>=0){
      const keepCat=items[i].cat; // preserva categoria ao editar
      const fotos = items[i].cat==='perifericos' ? dlgFotosTemp : (items[i].fotos||[]);
      items[i]={id:editingId,cat:keepCat,nome,peso,alt,larg,comp,fotos};
    }
  }else{
    const cat=currentCat || 'geral';
    const fotos = cat==='perifericos' ? dlgFotosTemp : [];
    items.unshift({id:uid(),cat,nome,peso,alt,larg,comp,fotos});
  }
  saveItems(); updateCountInfo(); $('#dlg').close(); renderTable();
}
function deleteFromModal(){
  if(!editingId) return;
  if(!confirm('Excluir este item?')) return;
  items=items.filter(x=>x.id!==editingId);
  selectedIds.delete(editingId);
  qtyMap.delete(editingId);
  saveItems(); updateCountInfo(); $('#dlg').close(); renderTable();
}

/* Eventos de fotos */
$('#fFotos').addEventListener('change', async (e)=>{
  const files=[...e.target.files].slice(0,30); // limite de seguran√ßa
  for(const f of files){
    try{ const dataUrl=await resizeImage(f,1280,0.8); dlgFotosTemp.push(dataUrl); }
    catch(_){ /* ignora arquivo problem√°tico */ }
  }
  renderFotoGrid();
  e.target.value='';
});

/* ===== Estimativa e caixas ===== */
const FATOR_CUBAGEM = 6000;
const BASE_FACTOR   = 2; // at√© 2x o maior item antes de "espalhar" mais

function getSelectedWithQty(){
  const arr=[];
  selectedIds.forEach(id=>{
    const it=items.find(x=>x.id===id);
    if(it){ arr.push({...it, qty: (qtyMap.get(id)||1)}); }
  });
  return arr;
}

function estimateBox(selectedAll){ // retorna m√©tricas considerando modo "caixa" quando houver
  const margin = Number($('#margin').value) || 0;
  const mode   = $('#packMode').value;

  const boxes = selectedAll.filter(it=>it.cat==='caixa');
  const equip = selectedAll.filter(it=>it.cat!=='caixa');

  const unidadesEquip = equip.reduce((s,it)=>s + (it.qty||0), 0);
  const pesoEquip     = equip.reduce((s,it)=>s + (it.peso||0)*(it.qty||0), 0);
  const volEquip      = equip.reduce((s,it)=>s + (it.alt||0)*(it.larg||0)*(it.comp||0)*(it.qty||0), 0);

  if(boxes.length>0){
    // capacidade e cubagem somadas por caixas
    let capacity=0, cubado=0;
    const boxTypes = boxes.map(b=>{
      const volUnit = (b.alt||0)*(b.larg||0)*(b.comp||0);
      capacity += volUnit*(b.qty||0);
      cubado   += (volUnit / FATOR_CUBAGEM) * (b.qty||0);
      return {id:b.id,nome:b.nome,qty:b.qty,alt:b.alt,larg:b.larg,comp:b.comp,volUnit};
    });
    const overflow = volEquip > capacity;
    let suggest=null;
    if(overflow && boxTypes.length===1){
      const bt=boxTypes[0];
      const needed = Math.max(0, Math.ceil(volEquip / bt.volUnit) - (bt.qty||0));
      if(needed>0) suggest = {boxId:bt.id, addQty:needed, boxName:bt.nome};
    }
    // Para exibi√ß√£o das dimens√µes: se uma √∫nica caixa, mostra; se m√∫ltiplas, deixa "‚Äì"
    let alt=0, larg=0, comp=0;
    if(boxTypes.length===1){
      alt = Math.ceil(boxTypes[0].alt);
      larg= Math.ceil(boxTypes[0].larg);
      comp= Math.ceil(boxTypes[0].comp);
    }
    return {
      usesBoxes:true, boxes:boxTypes, overflow, suggest,
      alt,larg,comp, cubado, pesoTotal:pesoEquip, unidades:unidadesEquip,
      volumeEq:volEquip, capacity
    };
  }

  // ===== Estimativa "normal" (sem caixas) sobre os equipamentos =====
  if(!equip.length) return {alt:0,larg:0,comp:0,cubado:0,pesoTotal:0,unidades:0,usesBoxes:false,boxes:[]};

  const maxAlt  = Math.max(...equip.map(it=>it.alt ||0));
  const maxLarg = Math.max(...equip.map(it=>it.larg||0));
  const maxComp = Math.max(...equip.map(it=>it.comp||0));

  const sumAlt  = equip.reduce((s,it)=>s + (it.alt ||0)*(it.qty||0), 0);
  const sumComp = equip.reduce((s,it)=>s + (it.comp||0)*(it.qty||0), 0);
  const sumBaseArea = equip.reduce((s,it)=>s + (it.larg||0)*(it.comp||0)*(it.qty||0), 0);

  let alt, larg, comp;

  if (mode === 'stack') {
    alt  = sumAlt;
    larg = maxLarg;
    comp = maxComp;
  } else if (mode === 'side') {
    alt  = maxAlt;
    larg = maxLarg;
    comp = sumComp;
  } else {
    const squareSide = Math.ceil(Math.sqrt(sumBaseArea));
    let idealLarg = Math.max(squareSide, maxLarg);
    let idealComp = Math.max(squareSide, maxComp);
    const capLarg = Math.ceil(maxLarg * BASE_FACTOR);
    const capComp = Math.ceil(maxComp * BASE_FACTOR);
    larg = Math.min(Math.ceil(idealLarg), capLarg);
    comp = Math.min(Math.ceil(idealComp), capComp);
    const cellsX = Math.max(1, Math.floor(larg / maxLarg));
    const cellsY = Math.max(1, Math.floor(comp / maxComp));
    const porCamada = Math.max(1, cellsX * cellsY);
    const camadas = Math.ceil(unidadesEquip / porCamada);
    alt = camadas * maxAlt;
    const volBasePorCamada = larg * comp * maxAlt;
    if (volBasePorCamada > 0) {
      const camadasVol = Math.ceil(volEquip / volBasePorCamada);
      alt = Math.max(alt, camadasVol * maxAlt);
    }
  }

  alt  = Math.ceil(alt  + margin);
  larg = Math.ceil(larg + margin);
  comp = Math.ceil(comp + margin);
  const cubado    = (alt * larg * comp) / FATOR_CUBAGEM;

  return { alt, larg, comp, cubado, pesoTotal:pesoEquip, unidades:unidadesEquip, usesBoxes:false, boxes:[] };
}

/* ===== Sele√ß√£o + Resumo ===== */
function updateSummary(){
  const sel=getSelectedWithQty();
  const est=estimateBox(sel);

  // contagem/peso s√≥ de equipamentos
  $('#resCount').textContent=est.unidades+' un.';
  $('#resPeso').textContent=fmtKG(est.pesoTotal);

  // dimens√µes exibidas
  $('#resAlt').textContent = est.alt ? (est.alt+' cm') : '‚Äì';
  $('#resLarg').textContent= est.larg? (est.larg+' cm') : '‚Äì';
  $('#resComp').textContent= est.comp? (est.comp+' cm') : '‚Äì';

  $('#resCubado').textContent=fmtKG(est.cubado);

  // aviso / sugest√£o de caixa + limite de peso Correios
  const warn=$('#boxWarn');
  let warnHtml = '';
  let showWarn = false;

  // (A) Avisos de caixa (j√° existentes)
  if(est.usesBoxes){
    if(est.overflow){
      showWarn = true;
      warnHtml += `<b>Caixa n√£o compat√≠vel com a quantidade de equipamentos.</b><br>
        Volume dos equipamentos: ${(est.volumeEq/1000).toFixed(0)} L ‚Ä¢ Capacidade das caixas: ${(est.capacity/1000).toFixed(0)} L.`;
      if(est.suggest){
        warnHtml += `<div style="margin-top:8px">
          <button class="btn" id="btnSuggestAddBox" data-box="${est.suggest.boxId}" data-add="${est.suggest.addQty}">
            Adicionar ${est.suggest.addQty} caixa(s)
          </button>
          <span class="hint" style="margin-left:8px">Caixa: ${est.suggest.boxName}</span>
        </div>`;
      }else{
        warnHtml += `<div class="hint" style="margin-top:6px">Ajuste manualmente as quantidades de caixas.</div>`;
      }
    }
  }

  // (B) NOVO: Limite de peso dos Correios (30 kg por volume)
  // Considera a regra pr√°tica de tarifa√ß√£o: o maior entre peso real e cubado.
  const pesoTarifado = Math.max(est.pesoTotal || 0, est.cubado || 0);
  if ((est.pesoTotal || 0) > LIMITE_PESO_CORREIOS){
  const msg = `Peso superior ao limite dos correrios, cota√ß√£o deve ser feito pela JEM`;
  showWarn = true;
  if (warnHtml) warnHtml += `<hr style="border:0;border-top:1px solid var(--line);margin:10px 0">`;
  warnHtml += `<b>${msg}</b><br><span class="hint">Peso total real: ${fmtKG(est.pesoTotal)}</span>`;
}

  if (showWarn){
    warn.innerHTML = warnHtml;
    warn.style.display = '';
    // reanexa listener do bot√£o de sugest√£o de caixa, se existir
    const btn=$("#btnSuggestAddBox");
    if(btn){
      btn.onclick=()=>{
        const id=btn.dataset.box;
        const add=Number(btn.dataset.add||0);
        const cur=(qtyMap.get(id)||1);
        qtyMap.set(id, cur+add);
        renderTable();
      };
    }
  }else{
    warn.style.display='none';
    warn.innerHTML='';
  }
}
function clearCurrentSimulation(){
  selectedIds.clear();
  qtyMap.clear();
  renderTable();
}

/* ===== Resumo em texto ===== */
function buildSummaryText(name=''){
  const sel=getSelectedWithQty();
  const est=estimateBox(sel);
  const modeLabel={auto:'Auto (camadas)',stack:'Empilhar',side:'Lado a lado'}[$('#packMode').value];
  const margin=Number($('#margin').value)||0;

  const itensEquip = sel.filter(i=>i.cat!=='caixa');
  const itensCaixa = sel.filter(i=>i.cat==='caixa');

  const itensEquipTxt = itensEquip.length
    ? itensEquip.map(it=>`- ${it.nome} ‚Äî ${it.peso} kg ‚Äî ${it.alt}√ó${it.larg}√ó${it.comp} cm ‚Äî Qtd: ${it.qty}`).join('\n')
    : '(nenhum equipamento selecionado)';

  const caixasTxt = itensCaixa.length
    ? '\nCaixas:\n' + itensCaixa.map(c=>`- ${c.nome} ‚Äî ${c.alt}√ó${c.larg}√ó${c.comp} cm ‚Äî Qtd: ${c.qty}`).join('\n')
    : '';

  return [
    name ? `Cota√ß√£o: ${name}` : 'Cota√ß√£o',
    `Itens de equipamento (${est.unidades} un.):`,
    itensEquipTxt,
    caixasTxt,
    `\nPeso total (equip.): ${est.pesoTotal.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})} kg`,
    est.usesBoxes
      ? `Cubagem (soma das caixas): ${est.cubado.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})} kg`
      : `Caixa estimada: ${est.alt}√ó${est.larg}√ó${est.comp} cm\nPeso cubado: ${est.cubado.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})} kg`,
    !est.usesBoxes ? `Empacotamento: ${modeLabel} | Folga: ${margin} cm` : `Empacotamento: caixas definidas`,
    `Data: ${new Date().toLocaleString('pt-BR')}`
  ].join('\n');
}
async function copySummary(){
  const text=buildSummaryText();
  try{ await navigator.clipboard.writeText(text); alert('Resumo copiado!'); }
  catch(_){
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); alert('Resumo copiado (fallback)!');
  }
}

/* ===== Cota√ß√µes (apenas 10) ===== */
function saveSimulation(name){
  const sel=getSelectedWithQty();
  if(!sel.length){ alert('Selecione ao menos um item.'); return; }
  name=(name||'').trim() || `Simula√ß√£o ${new Date().toLocaleDateString('pt-BR')}`;
  const est=estimateBox(sel);
  const sim={
    id:uid(),
    name,
    dateISO:new Date().toISOString(),
    packMode:$('#packMode').value,
    margin:Number($('#margin').value)||0,
    selected: sel.map(it=>({id:it.id, qty:it.qty})),
    snapshot: sel.map(it=>({nome:it.nome,cat:it.cat,qty:it.qty,peso:it.peso,alt:it.alt,larg:it.larg,comp:it.comp})),
    summary:{units:est.unidades,peso:est.pesoTotal,alt:est.alt,larg:est.larg,comp:est.comp,cubado:est.cubado,usesBoxes:est.usesBoxes},
    boxes: est.boxes || []
  };
  simsMain.push(sim);
  simsMain.sort((a,b)=>new Date(b.dateISO)-new Date(a.dateISO));
  if(simsMain.length>10){ simsMain=simsMain.slice(0,10); }
  saveSims(); renderSims();
  openSimDetails(sim.id, true);
  alert('Cota√ß√£o salva!');
}
function renderSims(){
  const tbody=$('#tbodyMain'); tbody.innerHTML='';
  simsMain.forEach(sim=>{
    const temCaixa = Array.isArray(sim.boxes) && sim.boxes.length>0;
    const caixaLabel = temCaixa
      ? (sim.boxes.length===1
          ? `${sim.boxes[0].alt}√ó${sim.boxes[0].larg}√ó${sim.boxes[0].comp} cm`
          : `${sim.boxes.length} tipos`)
      : `${sim.summary.alt}√ó${sim.summary.larg}√ó${sim.summary.comp} cm`;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${sim.name}</td>
      <td>${(sim.summary.units||0)}</td>
      <td>${sim.summary.peso.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})} kg</td>
      <td>${caixaLabel}</td>
      <td>${fmtDate(sim.dateISO)}</td>
      <td class="right">
        <button class="btn ghost simToggle" data-id="${sim.id}">Ver itens</button>
        <button class="btn ghost simApply"  data-id="${sim.id}">Aplicar</button>
        <button class="btn ghost simCopy"   data-id="${sim.id}">Copiar</button>
        <button class="btn red   simDel"    data-id="${sim.id}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);

    const trd=document.createElement('tr');
    trd.className='sim-detail';
    trd.id=`detail-${sim.id}`;
    trd.style.display='none';
    const itensTxt=(sim.snapshot||[]).map(s=>`‚Ä¢ [${s.cat}] ${s.nome}  ‚Äî  Qtd: ${s.qty}  ‚Äî  ${s.peso} kg  ‚Äî  ${s.alt}√ó${s.larg}√ó${s.comp} cm`).join('\n');
    trd.innerHTML=`<td colspan="6"><pre>${itensTxt || '‚Äî'}</pre></td>`;
    tbody.appendChild(trd);
  });
  $all('.simToggle').forEach(b=>b.addEventListener('click',()=>openSimDetails(b.dataset.id)));
  $all('.simApply').forEach(b=>b.addEventListener('click',()=>applySim(b.dataset.id)));
  $all('.simCopy').forEach(b =>b.addEventListener('click',()=>copySim(b.dataset.id)));
  $all('.simDel').forEach(b  =>b.addEventListener('click',()=>delSim(b.dataset.id)));
}
function openSimDetails(id, forceOpen=false){
  const row=document.getElementById(`detail-${id}`);
  if(!row) return;
  const btn=document.querySelector(`.simToggle[data-id="${id}"]`);
  const isHidden=row.style.display==='none';
  const willShow = forceOpen ? true : isHidden;
  row.style.display = willShow ? '' : 'none';
  if(btn) btn.textContent = willShow ? 'Ocultar itens' : 'Ver itens';
}
function findSim(id){ const idx=simsMain.findIndex(s=>s.id===id); return {idx, sim:simsMain[idx]}; }
function applySim(id){
  const {idx,sim}=findSim(id); if(idx<0) return;
  $('#packMode').value=sim.packMode||'auto';
  $('#margin').value=sim.margin||0;
  selectedIds=new Set();
  qtyMap=new Map();
  if(sim.selected){
    sim.selected.forEach(s=>{ selectedIds.add(s.id); qtyMap.set(s.id, clampQty(s.qty||1)); });
  }else{
    (sim.selectedIds||[]).forEach(id=>selectedIds.add(id));
    (sim.snapshot||[]).forEach(s=>{
      const it=items.find(x=>x.nome===s.nome);
      if(it){ selectedIds.add(it.id); qtyMap.set(it.id, clampQty(s.qty||1)); }
    });
  }
  renderTable(); alert('Simula√ß√£o aplicada.');
}
async function copySim(id){
  const {idx,sim}=findSim(id); if(idx<0) return;
  const itensTxt=(sim.snapshot||[]).map(s=>`- [${s.cat}] ${s.nome} ‚Äî Qtd: ${s.qty} ‚Äî ${s.peso} kg ‚Äî ${s.alt}√ó${s.larg}√ó${s.comp} cm`).join('\n');
  const body=[
    `Cota√ß√£o: ${sim.name}`,
    `Itens (equip.: ${sim.summary.units||0} un.):`,
    itensTxt||'(snapshot n√£o dispon√≠vel)',
    `\nPeso total (equip.): ${sim.summary.peso.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})} kg`,
    `Cubagem: ${sim.summary.cubado.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})} kg`,
    `Empacotamento: ${sim.summary.usesBoxes ? 'caixas' : sim.packMode} | Folga: ${sim.margin} cm`,
    `Data: ${fmtDate(sim.dateISO)}`
  ].join('\n');
  try{ await navigator.clipboard.writeText(body); alert('Resumo da simula√ß√£o copiado!'); }
  catch(_){ const ta=document.createElement('textarea'); ta.value=body; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Resumo copiado (fallback)!'); }
}
function delSim(id){
  if(!confirm('Excluir esta simula√ß√£o?')) return;
  const {idx}=findSim(id); if(idx<0) return;
  simsMain.splice(idx,1); saveSims(); renderSims();
}

/* ===== Eventos ===== */
$('#btnAdd').addEventListener('click', openNew);
$('#btnClear').addEventListener('click', ()=>{
  if(!confirm('Apagar TODOS os itens?')) return;
  items=[]; selectedIds.clear(); qtyMap.clear(); saveItems(); renderTable(); updateCountInfo();
});
$('#txtSearch').addEventListener('input', ()=>{currentPage=1; renderTable();});
$('#chkAll').addEventListener('change', (e)=>{
  $all('.rowchk').forEach(chk => {
    chk.checked = e.target.checked;
    const id=chk.dataset.id;
    const qtyInp=document.querySelector(`.qty[data-id="${id}"]`);
    if(e.target.checked){
      selectedIds.add(id);
      if(!qtyMap.has(id)) qtyMap.set(id,1);
      qtyInp.disabled=false; if(!qtyInp.value) qtyInp.value=1;
    }else{
      selectedIds.delete(id);
      qtyInp.disabled=true;
    }
  });
  updateSummary();
});
$('#btnPrev').addEventListener('click', ()=>{ if(currentPage>1){currentPage--; renderTable();} });
$('#btnNext').addEventListener('click', ()=>{ currentPage++; renderTable(); });
$('#packMode').addEventListener('change', updateSummary);
$('#margin').addEventListener('input', updateSummary);
$('#btnCopy').addEventListener('click', copySummary);
$('#btnSaveSim').addEventListener('click', ()=>{
  if(!getSelectedWithQty().length){ alert('Selecione ao menos um item.'); return; }
  $('#simName').value=''; $('#dlgSim').showModal();
});
$('#dlgSimClose').addEventListener('click', ()=>$('#dlgSim').close());
$('#dlgSimSave').addEventListener('click', ()=>{ saveSimulation($('#simName').value); $('#dlgSim').close(); });
$('#btnClearSim').addEventListener('click', clearCurrentSimulation);

/* Abas */
$all('#catTabs .tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $all('#catTabs .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentCat=btn.dataset.cat; currentPage=1; renderTable(); updateCountInfo();
  });
});

/* Modal */
$('#dlgClose').addEventListener('click', ()=>$('#dlg').close());
$('#dlgSave').addEventListener('click', saveFromModal);
$('#dlgDelete').addEventListener('click', deleteFromModal);
</script>
</body>
</html>
